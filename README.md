# I/O Benchmark: Laravel vs Go

é€™å€‹å°ˆæ¡ˆç”¨ä¾†æ¯”è¼ƒ Laravel å’Œ Go åœ¨è™•ç† I/O å¯†é›†å‹ä»»å‹™æ™‚çš„æ•ˆèƒ½å·®ç•°ã€‚

## ğŸ“š æ–‡ä»¶å°è¦½

- **[å¿«é€Ÿé–‹å§‹æŒ‡å—](QUICKSTART.md)** - 5 åˆ†é˜å¿«é€Ÿä¸Šæ‰‹
- **[å°ˆæ¡ˆçµæ§‹èªªæ˜](PROJECT_STRUCTURE.md)** - äº†è§£å°ˆæ¡ˆæ¶æ§‹
- **[æ¶æ§‹è©³è§£](ARCHITECTURE.md)** - PHP-FPM vs Go ä¸¦ç™¼æ¨¡å‹èªªæ˜
- **[å¯¦é©—å ±å‘Š](EXPERIMENT_REPORT.md)** - å®Œæ•´çš„æ•ˆèƒ½æ¸¬è©¦åˆ†æå ±å‘Š
- **æœ¬æ–‡ä»¶** - å®Œæ•´çš„ä½¿ç”¨èªªæ˜

## æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Go API    â”‚â”€â”€â”€â”€â”€â†’â”‚  IO Service  â”‚
â”‚  (port 8081)â”‚      â”‚  (port 8080) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ Laravel API â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (port 9000) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **IO Service**: æ¨¡æ“¬ I/O å»¶é²ï¼ˆ1 ç§’ï¼‰ï¼Œæ¸¬è©¦å¾Œç«¯æœå‹™
- **Go API**: ä½¿ç”¨ Go åŸç”Ÿ HTTP å®¢æˆ¶ç«¯å‘¼å« IO Serviceï¼ˆgoroutine ä¸¦ç™¼æ¨¡å‹ï¼‰
- **Laravel API**: ä½¿ç”¨ PHP-FPM + Nginx + Laravel HTTP Facade å‘¼å« IO Serviceï¼ˆé€²ç¨‹æ± æ¨¡å‹ï¼Œæœ€å¤š 50 workerï¼‰

## å¿«é€Ÿé–‹å§‹

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

```bash
# ä¸€éµåŸ·è¡Œï¼šå•Ÿå‹•æœå‹™ + å¥åº·æª¢æŸ¥ + å£“åŠ›æ¸¬è©¦
./run-tests.sh

# åŸ·è¡Œå®Œæ•´æ¯”è¼ƒæ¸¬è©¦ï¼ˆä¸‰è¼ªæ¸¬è©¦ï¼‰
./run-comparison.sh

# åˆ†ææ¸¬è©¦çµæœ
./analyze-results.sh

# åœæ­¢æ‰€æœ‰æœå‹™
./stop-services.sh
```

### æ–¹æ³•äºŒï¼šæ‰‹å‹•åŸ·è¡Œ

#### 1. å•Ÿå‹•æœå‹™

```bash
docker-compose up --build
```

#### 2. æ¸¬è©¦æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œ

```bash
# æ¸¬è©¦ IO Service
curl http://localhost:8080/io

# æ¸¬è©¦ Go API
curl http://localhost:8081/call

# æ¸¬è©¦ Laravel API
curl http://localhost:9000/api/call
```

#### 3. åŸ·è¡Œ k6 å£“åŠ›æ¸¬è©¦

#### å®‰è£ k6

**macOS:**
```bash
brew install k6
```

**Linux:**
```bash
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

**Windows:**
```powershell
choco install k6
```

#### åŸ·è¡Œæ¸¬è©¦

**æ¯”è¼ƒæ¸¬è©¦ï¼ˆæ¨è–¦ï¼‰:**
```bash
k6 run k6-test.js
```

**åªæ¸¬è©¦ Go API:**
```bash
k6 run k6-test-go-only.js
```

**åªæ¸¬è©¦ Laravel API:**
```bash
k6 run k6-test-laravel-only.js
```

**è‡ªè¨‚ä¸¦ç™¼æ•¸æ¸¬è©¦:**
```bash
# 100 å€‹ä¸¦ç™¼ç”¨æˆ¶ï¼ŒæŒçºŒ 30 ç§’
k6 run --vus 100 --duration 30s k6-test.js
```

**ç”¢ç”Ÿ HTML å ±å‘Š:**
```bash
k6 run k6-test.js --out json=results.json
```

## æ¸¬è©¦å ´æ™¯èªªæ˜

### k6-test.js (æ¯”è¼ƒæ¸¬è©¦)
- åŒæ™‚æ¸¬è©¦ Go å’Œ Laravel API
- é€æ­¥å¢åŠ è² è¼‰ï¼š10 â†’ 50 â†’ 100 å€‹ä¸¦ç™¼ç”¨æˆ¶
- è¨˜éŒ„è©³ç´°çš„æ•ˆèƒ½æŒ‡æ¨™å’Œæ¯”è¼ƒ
- ç”¢ç”Ÿæ ¼å¼åŒ–çš„æ¯”è¼ƒå ±å‘Š

### k6-test-go-only.js
- å°ˆæ³¨æ¸¬è©¦ Go API
- æ›´é«˜çš„ä¸¦ç™¼æ•¸ï¼š50 â†’ 100 â†’ 200

### k6-test-laravel-only.js
- å°ˆæ³¨æ¸¬è©¦ Laravel API
- æ›´é«˜çš„ä¸¦ç™¼æ•¸ï¼š50 â†’ 100 â†’ 200

## æ•ˆèƒ½æŒ‡æ¨™

æ¸¬è©¦æœƒè¨˜éŒ„ä»¥ä¸‹æŒ‡æ¨™ï¼š

- **æˆåŠŸç‡**: API å›æ‡‰ç‹€æ…‹ç¢¼ç‚º 200 çš„æ¯”ä¾‹
- **å¹³å‡å›æ‡‰æ™‚é–“**: æ‰€æœ‰è«‹æ±‚çš„å¹³å‡æ™‚é–“
- **ä¸­ä½æ•¸ (P50)**: 50% çš„è«‹æ±‚åœ¨æ­¤æ™‚é–“å…§å®Œæˆ
- **P95**: 95% çš„è«‹æ±‚åœ¨æ­¤æ™‚é–“å…§å®Œæˆ
- **P99**: 99% çš„è«‹æ±‚åœ¨æ­¤æ™‚é–“å…§å®Œæˆ
- **æœ€å°/æœ€å¤§å€¼**: æœ€å¿«å’Œæœ€æ…¢çš„è«‹æ±‚æ™‚é–“

## é æœŸçµæœ

ç”±æ–¼ IO Service æœ‰ 1 ç§’çš„å›ºå®šå»¶é²ï¼š

- **Go API**: 
  - å„ªå‹¢ï¼šæ›´ä½çš„è¨˜æ†¶é«”ä½¿ç”¨ã€æ›´é«˜çš„ä¸¦ç™¼è™•ç†èƒ½åŠ›
  - é æœŸå›æ‡‰æ™‚é–“ï¼š~1000-1100ms

- **Laravel API**: 
  - å„ªå‹¢ï¼šé–‹ç™¼é€Ÿåº¦å¿«ã€ç”Ÿæ…‹ç³»çµ±è±å¯Œ
  - é æœŸå›æ‡‰æ™‚é–“ï¼š~1000-1200msï¼ˆå–æ±ºæ–¼ PHP-FPM é…ç½®ï¼‰

## èª¿æ•´æ¸¬è©¦åƒæ•¸

ç·¨è¼¯ `k6-test.js` ä¸­çš„ `options.stages` ä¾†èª¿æ•´æ¸¬è©¦å ´æ™¯ï¼š

```javascript
export const options = {
  stages: [
    { duration: '30s', target: 10 },   // 30 ç§’å…§å¢åŠ åˆ° 10 å€‹ç”¨æˆ¶
    { duration: '1m', target: 50 },    // 1 åˆ†é˜å…§å¢åŠ åˆ° 50 å€‹ç”¨æˆ¶
    // åŠ å…¥æ›´å¤šéšæ®µ...
  ],
};
```

## æœ€ä½³åŒ–å»ºè­°

### Laravel æœ€ä½³åŒ–ï¼ˆå·²å¯¦ç¾ï¼‰
âœ… å·²å•Ÿç”¨ OPcache
âœ… å·²é…ç½® PHP-FPMï¼ˆå‹•æ…‹æ¨¡å¼ï¼Œæœ€å¤š 50 å€‹ workerï¼‰
âœ… ä½¿ç”¨ Nginx + PHP-FPM æ¶æ§‹ï¼ˆæ”¯æ´çœŸæ­£çš„ä¸¦ç™¼è™•ç†ï¼‰

### é€²éšæœ€ä½³åŒ–
- ä½¿ç”¨ Laravel Octane (Swoole/RoadRunner) ä»¥ç²å¾—æ›´é«˜æ•ˆèƒ½
- èª¿æ•´ PHP-FPM çš„ `pm.max_children` è¨­å®šï¼ˆç›®å‰ç‚º 50ï¼‰
- å•Ÿç”¨éŸ¿æ‡‰å¿«å–

### Go æœ€ä½³åŒ–
- èª¿æ•´ HTTP Client çš„é€£ç·šæ± è¨­å®š
- ä½¿ç”¨ goroutine pool
- èª¿æ•´ GOMAXPROCS

## æ¸…ç†

```bash
docker-compose down -v
```
